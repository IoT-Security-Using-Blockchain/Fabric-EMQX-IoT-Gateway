# ğŸŒ Fabric-EMQX-IoT-Gateway  
> Secure IoT Device Authentication & Data Transmission using **Hyperledger Fabric CA** + **EMQX Broker** + **AES Encryption**

[![GitHub stars](https://img.shields.io/github/stars/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway)](https://github.com/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway/stargazers)
[![GitHub issues](https://img.shields.io/github/issues/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway)](https://github.com/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway/issues)
[![Last commit](https://img.shields.io/github/last-commit/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway)](https://github.com/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway/commits/main)
[![License](https://img.shields.io/github/license/IoT-Security-Using-Blockchain/Fabric-EMQX-IoT-Gateway)](LICENSE)

---



This project demonstrates a **secure IoT data pipeline** where ESP32 devices send **AES-encrypted health data** through an **EMQX MQTT broker**, which authenticates devices against **Hyperledger Fabric CA identities**.  

It ensures that **only registered Fabric devices** can connect and publish data, making it suitable for **healthcare, supply chain, or critical IoT applications**.  

---

## ğŸ“‚ Project Structure
```markdown
Fabric-EMQX-IoT-Gateway/
â”‚â”€â”€ esp32/                     # ESP32 source code
â”‚   â”œâ”€â”€ main.ino                # MQTT + AES encryption code
â”‚   â”œâ”€â”€ README.md                
â”‚
â”‚â”€â”€ node-cli/                  # Node.js CLI for Fabric CA
â”‚   â”œâ”€â”€ registerDevice.js       # Register device & add to wallet
â”‚   â”œâ”€â”€ server.js       # Run the server to add data to Ledger
â”‚   â”œâ”€â”€ admin.id        # if other than admin other registered will be listed here
    â”œâ”€â”€ README.md
â”‚
â”‚â”€â”€ README.md                  # ğŸ“Œ Project readme
â”‚â”€â”€ LICENSE
```

## ğŸŒŸ Features
- âœ… **ESP32 integration** with heart-rate & SpO2 sensor.  
- ğŸ” **AES encryption** on device payloads.  
- ğŸªª **Device identity management** using Hyperledger Fabric CA.  
- ğŸ“¡ **EMQX authentication** via Fabric CA (API-based).  
- ğŸ—‚ **Device registration CLI tool** for onboarding new devices.  
- ğŸ“Š Health data format: `assetID`, `deviceId`, `spo2`, `heartRate`.  
- ğŸ”„ Secure end-to-end flow (ESP32 â†’ EMQX â†’ Fabric â†’ Server).  

---

## ğŸ— System Architecture
```mermaid
flowchart TD
    A[ESP32 AES Encrypted Data] --> B[EMQX Broker MQTT Gateway]
    B -->|HTTP Auth via Fabric CA API| C[Fabric CA Identity Verification]
    C --> D[Fabric Network Ledger + Chaincode]
    B --> E[Server App Decrypt & Store Data]
    E --> D
```

## âš¡ Prerequisites
- [Fabric Network Setup](https://github.com/IoT-Security-Using-Blockchain/Secure-IoMT-Edge-Data-via-Hyperledger-Fabric)  
  (Follow this repo for starting the Fabric CA and network)  
- EMQX 5.10+ installed (Enterprise or Open Source).  
- Node.js for the device registration CLI.  
- ESP32 board with sensors (SpO2, HR).  

---

## ğŸ”‘ Device Registration Workflow
We provide a **Node.js CLI tool** to register new IoT devices:  

```bash
# Register a device identity in Fabric CA and store it in the wallet
$ node manageDevice.js
```
> This creates a Fabric identity and allows EMQX to authenticate the ESP32 using its username and password given as a mqtt id and password.

### Output:
```markdown
Enrolling admin (will overwrite if exists)... ?
Admin enrolled and overwritten in wallet
? Choose an action: (Use arrow keys)
> Register/Enroll Device
List Enrolled Devices
Exit
```

## ğŸ“¡ ESP32 Payload Format

Each ESP32 sends data in the following structure:
```json
{
  "assetId": "asset-12345",
  "deviceId": "B4:E6:2D:34:AB:12",
  "spo2": 95,
  "heartRate": 102
}
```

- assetId â†’ unique per reading (generated by ESP32).
- deviceId â†’ ESP32 MAC address.
- spo2/heartRate â†’ live sensor values.

> Payload is AES-encrypted before transmission and decrypted on the server side.


## âš™ï¸ EMQX Authentication Setup
1. Go to Authentication tab in EMQX dashboard.
2. Choose HTTP Server as backend.
3. Configure authentication request body:
    ```json
    {
    "username": "${username}",
    "password": "${password}"
    }
    ```
4. Point the URL to your Fabric CA verification API.


## ğŸš€ How to Run
- Start the Fabric Network â†’ [Setup Guide](https://github.com/IoT-Security-Using-Blockchain/Secure-IoMT-Edge-Data-via-Hyperledger-Fabric)

- Run EMQX broker with HTTP authentication.

- Register devices via CLI (registerDevice.js).

- Flash ESP32 code (AES encryption enabled).

- Start the server to decrypt and process incoming data.
    ```bash
    node server.js              //To start the server
    ```


## ğŸ“Œ Example Workflow
1. Register ESP32 identity in Fabric CA.

2. ESP32 connects to EMQX with ID + password.

3. EMQX calls Fabric CA API â†’ verifies identity.

4. ESP32 sends AES-encrypted health data.

5. Server decrypts and processes data.


## ğŸ”® Future Enhancements

>- Add end-to-end ASCON lightweight encryption.

>- Deploy Grafana dashboards for real-time health monitoring.

>- Extend support for multiple IoT device types.


## ğŸ¯ Use Cases

>- ğŸ¥ Healthcare IoT Security (SPO2/Heart Monitoring)

>- ğŸ­ Industrial IoT with Blockchain trust

>- ğŸ” Secure MQTT IoT Gateway


## ğŸ“ License
***This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.***